import React, {useEffect, useRef} from 'react';
import mapboxgl from 'mapbox-gl';
import {UserGroupIcon} from "@heroicons/react/24/solid";
import 'mapbox-gl/dist/mapbox-gl.css';

const Map = () => {
    const mapContainerRef = useRef(null);
    const mapRef = useRef(null);
    const popupRef = useRef(new mapboxgl.Popup({offset: 10, closeButton: false}));

    useEffect(() => {
        if (!mapContainerRef.current) return;

        mapboxgl.accessToken = 'pk.eyJ1IjoiamlvdmFuaTEyMyIsImEiOiJjbTh2MHRrcjIwdG55MmlwZWY4OGdlODFnIn0.4GMKdr6qHSvdVINkE5vjsA';

        mapRef.current = new mapboxgl.Map({
            container: mapContainerRef.current,
            style: 'mapbox://styles/mapbox/standard-satellite',
            center: [120.42541155306827, 16.925393003030198],
            minZoom: 14,
            maxZoom: 14,
            dragPan:false,
        });

        let hoveredPolygonId = null;

        mapRef.current.on('load', () => {
            const polygonData = {
                type: "FeatureCollection",
                features: [

                    {
                        type: "Feature",
                        properties: {name: "Purok 1", population: 95, color: "rgba(223,109,109,0.57)"},
                        id: 4,
                        geometry: {
                            type: "Polygon",
                            coordinates: [[
                                [
                                    120.42403997685165,
                                    16.92520064278446
                                ],
                                [
                                    120.42412865472852,
                                    16.925110295436937
                                ],
                                [
                                    120.4242684125885,
                                    16.925015832113303
                                ],
                                [
                                    120.42443486280575,
                                    16.92499535040824
                                ],
                                [
                                    120.42482199501245,
                                    16.925128112660857
                                ],
                                [
                                    120.42495548843391,
                                    16.92525303481601
                                ],
                                [
                                    120.42520320160281,
                                    16.92549056496108
                                ],
                                [
                                    120.42544338726555,
                                    16.925626013750275
                                ],
                                [
                                    120.42577672792413,
                                    16.925229374636658
                                ],
                                [
                                    120.4264035488136,
                                    16.924619672914574
                                ],
                                [
                                    120.42641963019742,
                                    16.924555360168384
                                ],
                                [
                                    120.42581620730357,
                                    16.923912019160525
                                ],
                                [
                                    120.42565629818154,
                                    16.923475830178006
                                ],
                                [
                                    120.42532749048615,
                                    16.923067933549476
                                ],
                                [
                                    120.42482154869771,
                                    16.922253375968523
                                ],
                                [
                                    120.42476125706935,
                                    16.921895423161686
                                ],
                                [
                                    120.42457505390087,
                                    16.921581877771885
                                ],
                                [
                                    120.42432558916158,
                                    16.921188997505183
                                ],
                                [
                                    120.42415813574814,
                                    16.92089229489312
                                ],
                                [
                                    120.4237573786018,
                                    16.92050976886668
                                ],
                                [
                                    120.42356332956922,
                                    16.920695493496453
                                ],
                                [
                                    120.42330830614014,
                                    16.920871447411088
                                ],
                                [
                                    120.42309718292273,
                                    16.92090681452278
                                ],
                                [
                                    120.42299360268578,
                                    16.920892523421003
                                ],
                                [
                                    120.42281731060723,
                                    16.92088042047402
                                ],
                                [
                                    120.42253896307545,
                                    16.9209004024044
                                ],
                                [
                                    120.42232463950523,
                                    16.921022906772507
                                ],
                                [
                                    120.42213379082534,
                                    16.92112149371907
                                ],
                                [
                                    120.42190887340001,
                                    16.921290738521748
                                ],
                                [
                                    120.42202670866425,
                                    16.92155411741497
                                ],
                                [
                                    120.42236176627745,
                                    16.921967631941527
                                ],
                                [
                                    120.42238021445979,
                                    16.922344251884553
                                ],
                                [
                                    120.42236983258891,
                                    16.922438392432156
                                ],
                                [
                                    120.4224978688685,
                                    16.92242034015537
                                ],
                                [
                                    120.42252512985914,
                                    16.922421886322326
                                ],
                                [
                                    120.42262183403176,
                                    16.922504171621853
                                ],
                                [
                                    120.42265497022208,
                                    16.922533939458447
                                ],
                                [
                                    120.42268024263922,
                                    16.922625473938112
                                ],
                                [
                                    120.42276585074353,
                                    16.922821686810437
                                ],
                                [
                                    120.42293000952247,
                                    16.9230746989587
                                ],
                                [
                                    120.4232110794901,
                                    16.923648406781865
                                ],
                                [
                                    120.4232150276145,
                                    16.923693251945394
                                ],
                                [
                                    120.42305279936181,
                                    16.923799894427972
                                ],
                                [
                                    120.42321168580662,
                                    16.92410346449691
                                ],
                                [
                                    120.42340355673628,
                                    16.924342026739765
                                ],
                                [
                                    120.42350612484285,
                                    16.924504311065206
                                ],
                                [
                                    120.42358589417768,
                                    16.924575970929837
                                ],
                                [
                                    120.42368787025941,
                                    16.924667579930684
                                ],
                                [
                                    120.42376585599095,
                                    16.924740975288273
                                ],
                                [
                                    120.42382934809575,
                                    16.92481136394764
                                ],
                                [
                                    120.4238687367623,
                                    16.92486009957318
                                ]]],
                        }
                    }, {
                        type: "Feature",
                        properties: {name: "Purok 2", population: 113, color: "rgba(161,161,255,0.59)"},

                        id: 2,
                        geometry: {
                            type: "Polygon",
                            coordinates: [[[

                                120.4217409226012,
                                16.92279204125917
                            ],
                                [
                                    120.42105487256072,
                                    16.92360911906154
                                ],
                                [
                                    120.4209428643926,
                                    16.923528750912567
                                ],
                                [
                                    120.42048104164905,
                                    16.924008992806435
                                ],
                                [
                                    120.42032040765105,
                                    16.92398017832693
                                ],
                                [
                                    120.42028024915152,
                                    16.92388413003202
                                ],
                                [
                                    120.42016981327828,
                                    16.92377847684989
                                ],
                                [
                                    120.41990878303227,
                                    16.924124250678872
                                ],
                                [
                                    120.41975818865797,
                                    16.924421999855795
                                ],
                                [
                                    120.41965779240996,
                                    16.924729353350642
                                ],
                                [
                                    120.41948711878666,
                                    16.924969472920367
                                ],
                                [
                                    120.41942688103819,
                                    16.92519998741811
                                ],
                                [
                                    120.4195875150362,
                                    16.925334454078595
                                ],
                                [
                                    120.41970799053473,
                                    16.925382477862996
                                ],
                                [
                                    120.41980838678273,
                                    16.925488130144387
                                ],
                                [
                                    120.41991882265597,
                                    16.925593782366448
                                ],
                                [
                                    120.4200392981545,
                                    16.925516944392385
                                ],
                                [
                                    120.42018989252728,
                                    16.925516944392385
                                ],
                                [
                                    120.42028024915152,
                                    16.92563220134177
                                ],
                                [
                                    120.42029028877676,
                                    16.92570903926881
                                ],
                                [
                                    120.42034048689999,
                                    16.92582429610063
                                ],
                                [
                                    120.42037060577582,
                                    16.92595876231522
                                ],
                                [
                                    120.42045092277482,
                                    16.92603560010903
                                ],
                                [
                                    120.42041909073515,
                                    16.926828041469108
                                ],
                                [
                                    120.42059343626488,
                                    16.926855903030514
                                ],
                                [
                                    120.42087641651221,
                                    16.927042384053166
                                ],
                                [
                                    120.42108788374924,
                                    16.927154891857384
                                ],
                                [
                                    120.42126202609637,
                                    16.927447709993373
                                ],
                                [
                                    120.42129854332154,
                                    16.92758098763207
                                ],
                                [
                                    120.42137288818384,
                                    16.927657438718157
                                ],
                                [
                                    120.42172744555745,
                                    16.927438214985557
                                ],
                                [
                                    120.4219313238487,
                                    16.927296184987554
                                ],
                                [
                                    120.42214359345974,
                                    16.927173688572893
                                ],
                                [
                                    120.42230043841056,
                                    16.927126721151083
                                ],
                                [
                                    120.42245537501924,
                                    16.926976969440602
                                ],
                                [
                                    120.42255423987115,
                                    16.926828041469108
                                ],
                                [
                                    120.42262715481564,
                                    16.926790937031257
                                ],
                                [
                                    120.4227785730709,
                                    16.926578865198508
                                ],
                                [
                                    120.42291218302267,
                                    16.926432318065665
                                ],
                                [
                                    120.42302710651546,
                                    16.926295654521653
                                ],
                                [
                                    120.42314225170037,
                                    16.926186824740867
                                ],
                                [
                                    120.42334278078596,
                                    16.925934604532188
                                ],
                                [
                                    120.42338460812573,
                                    16.925836169638174
                                ],
                                [
                                    120.42346168400087,
                                    16.92572030724675
                                ],
                                [
                                    120.42358689090574,
                                    16.9256980934407
                                ],
                                [
                                    120.42371209781061,
                                    16.925675879634653
                                ],
                                [
                                    120.42388774014853,
                                    16.925408356740107
                                ],
                                [
                                    120.42388933800908,
                                    16.925416362952348
                                ],
                                [
                                    120.42402708511361,
                                    16.9252034478819
                                ],
                                [
                                    120.42389216917985,
                                    16.92498258116325
                                ],
                                [
                                    120.42383439058955,
                                    16.924868349169287
                                ],
                                [
                                    120.42371916285555,
                                    16.924743976752325
                                ],
                                [
                                    120.42359980928711,
                                    16.92460922285369
                                ],
                                [
                                    120.42342973243916,
                                    16.924457908166787
                                ],
                                [
                                    120.42332590957733,
                                    16.924305058122343
                                ],
                                [
                                    120.42315962244885,
                                    16.924080403618206
                                ],
                                [
                                    120.42300422840128,
                                    16.923800384173816
                                ],
                                [
                                    120.42319762518974,
                                    16.923674398960728
                                ],
                                [
                                    120.42293858791226,
                                    16.923134786388573
                                ],
                                [
                                    120.42271260712312,
                                    16.922775736772095
                                ],
                                [
                                    120.42261279582107,
                                    16.92253223311728
                                ],
                                [
                                    120.422512044565,
                                    16.92243835298214
                                ],
                                [
                                    120.42227894669327,
                                    16.92246461746744
                                ]]]
                        }
                    }, {
                        type: "Feature",
                        properties: {name: "Purok 3", population: 70, color: "rgba(145,255,152,0.73)"},
                        id: 3,
                        geometry: {
                            type: "Polygon",
                            coordinates: [[


                                [
                                    120.42005839094259,
                                    16.929207998130806
                                ],
                                [
                                    120.42008556929471,
                                    16.928944233510336
                                ],
                                [
                                    120.42071230193608,
                                    16.928742453988278
                                ],
                                [
                                    120.42127483566304,
                                    16.928405416089177
                                ],
                                [
                                    120.42165513893138,
                                    16.928159605285202
                                ],
                                [
                                    120.42138205374272,
                                    16.92767364220937
                                ],
                                [
                                    120.42181603643195,
                                    16.927407278052
                                ],
                                [
                                    120.42204752284493,
                                    16.92725289694104
                                ],
                                [
                                    120.42228721871345,
                                    16.927150175442492
                                ],
                                [
                                    120.422473105726,
                                    16.926995090051193
                                ],
                                [
                                    120.4225556700274,
                                    16.926864830934974
                                ],
                                [
                                    120.42263276325991,
                                    16.926816182634
                                ],
                                [
                                    120.42289385931826,
                                    16.926472444573974
                                ],
                                [
                                    120.42312653970771,
                                    16.926235385202716
                                ],
                                [
                                    120.4233064970145,
                                    16.926021887993045
                                ],
                                [
                                    120.42335794764779,
                                    16.925961930732683
                                ],
                                [
                                    120.42340033518428,
                                    16.925858439431863
                                ],
                                [
                                    120.42344713435847,
                                    16.925773068141552
                                ],
                                [
                                    120.42370098526288,
                                    16.925717971714533
                                ],
                                [
                                    120.42376353351267,
                                    16.92598475706579
                                ],
                                [
                                    120.4239571784073,
                                    16.9260589583386
                                ],
                                [
                                    120.42415510267324,
                                    16.92608158388562
                                ],
                                [
                                    120.42461552565038,
                                    16.92627351610865
                                ],
                                [
                                    120.42487299393008,
                                    16.926471555579198
                                ],
                                [
                                    120.42498029198947,
                                    16.92664553232086
                                ],
                                [
                                    120.42469534826881,
                                    16.927065680716794
                                ],
                                [
                                    120.42456928205627,
                                    16.92722953056048
                                ],
                                [
                                    120.42433126288358,
                                    16.927259558317076
                                ],
                                [
                                    120.42412102457513,
                                    16.927225870891803
                                ],
                                [
                                    120.42392069858562,
                                    16.927311927250585
                                ],
                                [
                                    120.42368440851567,
                                    16.92757627056693
                                ],
                                [
                                    120.42349249272513,
                                    16.927736385266925
                                ],
                                [
                                    120.42337723843514,
                                    16.927865611549976
                                ],
                                [
                                    120.4231890779414,
                                    16.92813993828065
                                ],
                                [
                                    120.4225983177135,
                                    16.92907231534005
                                ],
                                [
                                    120.42218242589416,
                                    16.92950783127351
                                ],
                                [
                                    120.42181241047251,
                                    16.929884803597844
                                ],
                                [
                                    120.42109415201958,
                                    16.930392294622564
                                ],
                                [
                                    120.42093294289253,
                                    16.93021422743952
                                ],
                                [
                                    120.42077233628044,
                                    16.93023620901893
                                ],
                                [
                                    120.42066165845324,
                                    16.929959445599508
                                ],
                                [
                                    120.42052823019174,
                                    16.929717663671966
                                ],
                                [
                                    120.42039240020688,
                                    16.929584561891332
                                ],
                                [
                                    120.42013065255577,
                                    16.92943810048422
                                ],
                                [
                                    120.42004572939993,
                                    16.92921772318155
                                ]
                            ]]
                        }
                    }, {
                        type: "Feature",
                        properties: {name: "Purok 4", population: 78, color: "rgba(36,36,239,0.59)"},
                        id: 1,
                        geometry: {
                            type: "Polygon",
                            coordinates: [[
                                [
                                    120.4254103375568,
                                    16.926013939598988
                                ],
                                [
                                    120.42554709666416,
                                    16.926048681789013
                                ],
                                [
                                    120.42559745046748,
                                    16.926090234800725
                                ],
                                [
                                    120.4257498933535,
                                    16.926310127633016
                                ],
                                [
                                    120.42635893471981,
                                    16.927138747510057
                                ],
                                [
                                    120.42665441716213,
                                    16.927471561469204
                                ],
                                [
                                    120.42689257309615,
                                    16.927428612087354
                                ],
                                [
                                    120.42747408905325,
                                    16.927484210066652
                                ],
                                [
                                    120.42792580391,
                                    16.927323471065407
                                ],
                                [
                                    120.42819101852064,
                                    16.927283881879163
                                ],
                                [
                                    120.42847342279924,
                                    16.92728177140519
                                ],
                                [
                                    120.42861305460104,
                                    16.927082824267032
                                ],
                                [
                                    120.42893291720463,
                                    16.926840433297187
                                ],
                                [
                                    120.4291422653506,
                                    16.92677311678881
                                ],
                                [
                                    120.4293388413497,
                                    16.9269291395005
                                ],
                                [
                                    120.43009303460491,
                                    16.926525231262573
                                ],
                                [
                                    120.43007516947773,
                                    16.926391417435994
                                ],
                                [
                                    120.42997509628975,
                                    16.926343071323387
                                ],
                                [
                                    120.42948313698571,
                                    16.926568708079017
                                ],
                                [
                                    120.4292561889057,
                                    16.9261912786653
                                ],
                                [
                                    120.42897187363076,
                                    16.926268717982524
                                ],
                                [
                                    120.42868635316609,
                                    16.92622203679241
                                ],
                                [
                                    120.428207160049,
                                    16.92610182685071
                                ],
                                [
                                    120.4276090481722,
                                    16.925534199299193
                                ],
                                [
                                    120.42721212390256,
                                    16.9251658839747
                                ],
                                [
                                    120.426448205991,
                                    16.924573956923822
                                ],
                                [
                                    120.42642565599084,
                                    16.9245649944899
                                ],
                                [
                                    120.42641517828656,
                                    16.924624705075445
                                ],
                                [
                                    120.4257597742423,
                                    16.92526605218896
                                ],
                                [
                                    120.42544421324016,
                                    16.925634880531362
                                ]]]
                        }
                    },
                ]
            };

            mapRef.current.addSource('states', {
                type: 'geojson',
                data: polygonData
            });

            mapRef.current.addLayer({
                id: 'state-fills',
                type: 'fill',
                source: 'states',
                layout: {},
                paint: {
                    'fill-color': ['get', 'color'],
                    'fill-opacity': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        1,
                        0.5
                    ]
                }
            });


            mapRef.current.addLayer({
                id: 'state-borders',
                type: 'line',
                source: 'states',
                layout: {},
                paint: {
                    'line-color': '#8383fd',
                    'line-width': 1
                }
            });

            mapRef.current.on('mousemove', 'state-fills', (e) => {
                if (e.features.length > 0) {
                    const featureId = e.features[0].id;
                    if (featureId !== undefined) {
                        if (hoveredPolygonId !== null) {
                            mapRef.current.setFeatureState(
                                {source: 'states', id: hoveredPolygonId},
                                {hover: false}
                            );
                        }
                        hoveredPolygonId = featureId;
                        mapRef.current.setFeatureState(
                            {source: 'states', id: hoveredPolygonId},
                            {hover: true}
                        );

                        popupRef.current
                            .setLngLat(e.lngLat)
                            .setHTML(`<div class="flex flex-col px-2">

                       <p class="text-['${e.features[0]?.properties?.color}']">    ${e.features[0]?.properties?.name}</p>
                           <div class="flex gap-2 font-bold">
                           <img src="https://www.svgrepo.com/show/447662/group.svg" class="population" alt="">
                           ${e.features[0]?.properties?.population}</div>
                           </div>`).addTo(mapRef.current)
                    }
                }
            });

            mapRef.current.on('mouseleave', 'state-fills', () => {
                if (hoveredPolygonId !== null) {
                    mapRef.current.setFeatureState(
                        {source: 'states', id: hoveredPolygonId},
                        {hover: false}
                    );
                }
                hoveredPolygonId = null;
                popupRef.current.remove();
            });
        });

        return () => {
            if (mapRef.current) {
                mapRef.current.remove();
            }
        };
    }, []);

    return <div ref={mapContainerRef} style={{height: "100%", width: "100%", borderRadius: 11,position:"relative"}}>
            <div className={"absolute z-[1111] right-5 bg-white px-5 py-2 rounded-md top-5 flex place-items-center gap-1"}><UserGroupIcon className="h-5 text-indigo-700 "/>Total Population : {113+70+95+78}</div>
          </div>;
};

export default Map;
